# Polygon

Polygon 是 EOJ 自带的命题系统。其附带功能包括权限管理、题目规范化、数据修复、数据验证、题目测试等等。

EOJ Polygon 需要用户手动开通，开通是要满足至少一项要求：

+ 过题 100 以上；
+ 拥有非普通用户权限（开通时）。

## 权限控制

我们将 git 的概念引申一下：每个问题 (Problem) 都是一个 Repository，确切地说，是一个私有仓库。明确这一点后，下文将对题目和仓库的概念进行混用。

我们先介绍用户对题目的权限的四种类型：

1. ADMIN：管理员导入仓库后自动为 ADMIN，这一权限由仓库本身管理，不随管理员权限的改变而改变。除了必要时候删除 WRITE 权限的资格外，管理员权限和 OWNER 权限实际上是等价的。
2. WRITE：如果创建仓库的人不是管理员，那么创建后权限即为 WRITE。具有 WRITE 权限的还可以邀请他人具有 WRITE/READ 权限，或者批准他人的 WRITE/READ 权限申请。
3. READ: 顾名思义，只具有查看权限。

用户在编辑问题时需要新建一个 EditSession（为方便起见，下面称为暂存区，不是翻译）。一个用户对一个问题只能拥有一个暂存区，对暂存区进行的更改都将被暂存。
**但这并不意味着可以回滚。** 这些更改依然会对你暂存区内的文件生效，只不过，你只要不提交就不会成为正式的题目而已。

对暂存区有两种操作：

1. Synchronize (同步)：再次下载发布版的题目到暂存区
2. Commit (提交)：提交更改到暂存区

需要提醒的是，EOJ Polygon 没有对多人协作进行冲突处理，如果你要提交的暂存区不是主暂存区，恐怕你只能进行同步操作。这会抹掉相应的数据。所以正确的做法是：不要等到天荒地老再提交……

有关主暂存区的更多内容，请看详解。

用户 Commit 之后，可以用问题仓库中提供的 Problem ID 和 Alias (别名) 来访问到问题。问题在 Problemset 中默认是不可见的，要使它可见需要联系管理员。但用户可以创建比赛并使用题目。

### 详解

用户创建仓库有两种方式：

1. 从现有仓库导入（fork）；
2. 创建新仓库。

Polygon 管理基于文件系统（而不是数据库），每个题目，每个用户的 fork 都会作为一个单独的、独立的文件夹存放。这个文件夹便是暂存区。
这个文件夹中不仅会包含问题的描述，相应的数据，配置信息（往往是 JSON），还包含一系列生成器、验证器等相关产物（下面会作具体解释）。
但根据 EOJ Polygon 的规则，结合个人需要，不是所有的这些东西都会、都能够放到最终的题目中。这就造成了暂存区的实际存储内容比提交内容更丰富的情况。

基于这点考虑，再加上老版本迁移等历史遗留问题的考虑，一个题目没有任何暂存区与之对应（老题目无人管理）。一旦有人管理，就一定会有一个是它的主暂存区。
主暂存区并不是暂存区的一个属性，而是一种基于规则的定义：如果你的仓库的最后一次同步操作或提交操作是此问题所有暂存区中最晚的，那么你就是主暂存区。
只有拥有主暂存区的且拥有写权限的用户才可以提交。

在上面创建仓库的两种方式的第一种中，用户必须先具有读或写权限。如果是写权限，那么会创建一个新的暂存区；如果是读权限，则可以看到当前问题的所有暂存区；
如果该问题没有任何已经创建的暂存区，系统会自动创建一个暂存区并归入批准操作的管理员的名下。
