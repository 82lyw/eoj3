{% extends 'contest/base.jinja2' %}
{% from 'components/modal.jinja2' import modal %}
{% from 'contest/standings_snippet.jinja2' import display_rank, display_rank_head with context %}
{% from 'components/timeanddate_link.jinja2' import timeanddate_link %}

{% macro separator() %}
  <div class="ui hidden divider"></div>
{% endmacro %}

{% block contest_content %}

  {% include 'components/message.jinja2' %}

  {% if not registered and contest.status <= 0 %}
    {# private contest registration #}
    <div>
      <h3 class="ui header">
        <i class="privacy icon"></i>
        <div class="content">
          Permission Notice
          <div class="sub header">This contest is private. You can either</div>
        </div>
      </h3>
      <ul class="ui list">
        <li class="item">Enter a valid invitation code to join the contest, OR</li>
        <li class="item">Re-login with the given account.</li>
      </ul>
      <form class="ui form" action="{{ url('contest:invitation', contest.pk) }}" method="post">
        {% csrf_token %}
        <div class="ui action fluid input">
          <input type="text" name="code" placeholder="If you have an invitation code..." style="font-family:monospace">
          <button type="submit" class="ui button">Join the contest</button>
        </div>
      </form>
    </div>
    {{ separator() }}
  {% endif %}

  {% if (public_register == -1 or public_register == 1) and not has_permission %}
    {# public rated contest registration #}
    <div class="ui info message">
      <div class="header">
        Rated contest requires registration.
      </div>
      <ul class="list">
        <li>You need to register, before the contest begins, to be rated in this contest.</li>
        <li>If you fail to register, you can still participate in the contest, but you will be an un-rated participant (by automatically starred).</li>
        <li>You can cancel your registration before the contest begins. But if you don't, you <b>will be considered a participant</b> in the contest, and be rated, even if you haven't submit any solution.</li>
      </ul>
    </div>
    {% if public_register == -1 %}
    <form class="ui form" action="{{ url('contest:public_register', contest.pk) }}" method="post">
      {% csrf_token %}
      <button class="fluid ui primary button">OK, Register</button>
    </form>
    {% else %}
    <form class="ui form" action="{{ url('contest:public_register', contest.pk) }}" method="post">
      {% csrf_token %}
      <button class="fluid ui red button">Cancel my registration</button>
    </form>
    {% endif %}
    {{ separator() }}
  {% else %}

  {% if has_permission %}

    {# proble list #}
    <table class="ui unstackable celled table">
      <thead>
        <tr class="center aligned">
          <th class="two wide">#</th>
          <th class="left aligned">Name</th>
          <th class="three wide">Solved</th>
        </tr>
      </thead>
      <tbody>
        {% for contest_problem in contest_problem_list %}
        <tr class="center aligned">
          <td class="semi-bold">{{ contest_problem.identifier }}</td>
          <td class="left aligned">
            <a href="{{ url('contest:problem', contest.pk, contest_problem.identifier) }}">
            {{ contest_problem.problem.title }}</a>
            {% if not site_closed and (contest_problem.problem.visible or is_privileged) %}
              <a style="float: right;" data-tooltip="Practice in problemset" href="{{ url('problem:detail', contest_problem.problem.pk) }}"><i class="icon external"></i></a>
            {% endif %}
          </td>
          <td class="selectable {% if contest_problem.personal_label == 1 %}accepted{% elif contest_problem.personal_label == 2 %}warning{% elif contest_problem.personal_label < 0 %}attempted{% endif %}">
            <a {% if contest_problem.personal_label == 2 %}data-tooltip="Accepted out of this contest" data-inverted=""{% endif %} href="{{ url('contest:status', contest.pk) }}?problem={{ contest_problem.identifier }}&verdict=v0">
              <i class="icon fitted user" aria-hidden="true"></i> x {{ contest_problem.accept_count }}
            </a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    {{ separator() }}

    {# personal score #}

    {% if rank %}
      <h3 class="ui header">
        <i class="student icon"></i>
        <div class="content">
          My Score
          <div class="sub header">Might be cached for a few seconds.</div>
        </div>
      </h3>

      <table class="ui compact celled table">
        {% if (contest.contest_problem_list | length) > 6 and not contest.standings_without_problem %}
          {% set column_style = 'collapsing' %}
        {% else %}
          {% set column_style = 'one wide' %}
        {% endif %}
        <thead>
          <tr class="ui center aligned">
            {{ display_rank_head(column_style) }}
          </tr>
        </thead>
        <tbody>
          <tr class="ui center aligned">
            {{ display_rank(rank) }}
          </tr>
        </tbody>
      </table>

      {{ separator() }}
    {% endif %}

    {# clarification #}
    <h3 class="ui header">
      <i class="help circle icon"></i>
      <div class="content">
        Clarifications
        <div class="sub header">Ask questions and receive notifications</div>
      </div>
    </h3>
    {% if is_privileged %}
      {% set clarification_modal_name = "Post a notification" %}
    {% else %}
      {% set clarification_modal_name = "Ask a question" %}
    {% endif %}

    <table class="ui celled table">
      <thead>
        <tr class="center aligned">
          <th class="collapsing">Time</th>
          <th class="collapsing">User</th>
          <th>Questions</th>
          <th>Answers</th>
        </tr>
      </thead>
      <tbody>
      {% for clarification in clarifications %}
        <tr>
          <td class="center aligned collapsing">{{ clarification.time | date('Y-m-d H:i:s') }}</td>
          <td class="center aligned collapsing">{{ username_display(clarification.author) }}</td>
          {% if clarification.text %}
          <td>{{ clarification.text }}</td>
          <td>
          {% else %}
          <td colspan="2">
          {% endif %}
            {{ clarification.answer }}
            {% if is_privileged %}
              <i class="icon link edit modal-link" data-target="#clarificationAnswerModal"
                 data-action="{{ url('contest:clarification_answer', contest.pk, clarification.pk) }}"></i>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4">
            <button class="ui primary labeled icon right floated small button modal-link" data-target="#clarificationModal">
              <i class="icon add"></i> {{ clarification_modal_name }}
            </button>
          </th>
        </tr>
      </tfoot>
    </table>

    {{ separator() }}

    {% call modal(clarification_modal_name, action=url('contest:clarification', contest.pk), id="clarificationModal") %}
      {% csrf_token %}
      <div class="field">
        <textarea name="text"></textarea>
      </div>
    {% endcall %}

    {% call modal("Answer a question", action=url('contest:clarification', contest.pk), id="clarificationAnswerModal") %}
      {% csrf_token %}
      <div class="field">
        <label>Edit your answer here:</label>
        <textarea name="text"></textarea>
      </div>
    {% endcall %}

  {% endif %}
  {% endif %}

  {# score distribution (for rated contest and scoring contest) #}
  {% if contest.rated and (contest.scoring_method == 'cf' or contest.scoring_method == 'oi') %}
    <h3 class="ui header">
      <i class="bar chart icon"></i>
      <div class="content">
        Point Values
      </div>
    </h3>
    <p>This will be a <b>rated</b> contest and here are the points for each problem:</p>
    <div class="ui grid">
      <div class="sixteen wide mobile twelve wide tablet eight wide computer column">
        <table class="ui unstackable center aligned striped celled table">
          <thead>
            <tr>
              <th>Task</th><th>Score</th>
            </tr>
          </thead>
          <tbody>
          {% for problem in contest_problem_list %}
            <tr>
              <td>{{ problem.identifier }}</td>
              <td>{{ problem.weight }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <p>Information above are not guaranteed to stay unchanged before the contest.</p>
    </div>


    {{ separator() }}
  {% endif %}

  {% if contest.description %}
    <h3 class="ui header">
      <i class="announcement icon"></i>
      <div class="content">
        Announcement
        <div class="sub header">Contest writer has something to say</div>
      </div>
    </h3>

    {{ contest.description | markdown | safe }}

    {{ separator() }}

  {% endif %}

  {# contest information (always public) #}

  <h3 class="ui header">
    <i class="info circle icon"></i>
    <div class="content">
      Contest Information and Rules
      <div class="sub header">Read this carefully</div>
    </div>
  </h3>

  <ul class="ui list">
    <li class="item">
    {% if authors %}
      Contest Authors: {% for author in authors %}{{ username_display(author) }}{% if not loop.last %},{% endif %} {% endfor %}
    {% else %}
      Contest authors have not been disclosed yet.
    {% endif %}
    </li>
    <li class="item">
      Contest Access: {% if contest.public %}<b>Public</b>{% else %}<b>Private</b>{% endif %}
    </li>
    {% if contest.always_running %}
      <li class="item">
        Contest Duration: <b>Always Running</b>
      </li>
    {% else %}
      <li class="item">
        Contest Duration: <b>{{ (contest.end_time - contest.start_time) | naturalduration(abbr=False) }}</b>
      </li>
      <li class="item">
        Start time: {{ timeanddate_link(contest.start_time) }} ({{ contest.start_time | naturaltime }})
      </li>
    {% endif %}
    {% if contest.freeze %}
      <li class="item">
        Standings frozen after {{ contest.freeze_time | date('Y-m-d H:i:s') }} ({{ contest.freeze_time | naturaltime }}).
      </li>
    {% endif %}
    <li class="item">
      Supported languages: {{ contest.verbose_supported_language_list }}.
    </li>
    <li class="item">
      {% if contest.scoring_method == 'acm' %}
      Based on traditional ACM-ICPC scoring method. Contestants are ranked according to the most problems solved. Contestants who solve the same number of problems are ranked by penalty, if penalty is calculated.
      {% elif contest.scoring_method == 'oi' %}
      Based on COI (Chinese OI) scoring method. All test cases will be judged. Contestant's score on a single problem will be determined by the percentage of <b>weighted</b> sum of all passed test cases. The sum score is simply the <b>weighted</b> sum of score that is earned in each problem.
      {% elif contest.scoring_method == 'cf' %}
      Scoring rule of this contest is very similar to <a href="http://codeforces.com/">Codeforces</a> regular round. Basically, When you solve a problem, you get a score assigned to it. This score drops as time goes by. It will be half the score when the contest ends. 50 points will be lost for each rejected solutions. At least 0.3 times the original score will be earned if the problem is successfully solved at the end.
      {% elif contest.scoring_method == 'tcmtime' %}
      This contest uses TCM/TIME Rule. The winner is the participant who correctly solves the greatest number of problems. If several participants solve the same number of problems, then the competitor with the smaller penalty time will rank higher.
      {% endif %}
    </li>
    <li class="item">
      {% if contest.run_tests_during_contest == 'all' %}
      This contest is full-feedback (solutions are fully judged during the contest).
      {% elif contest.run_tests_during_contest == 'pretest' %}
      Only pretests will be judged during the contest. There will be system tests after the contest.
      {% elif contest.run_tests_during_contest == 'sample' %}
      Only samples will be judged during the contest. There will be system tests after the contest.
      {% else %}
      All solutions will not be judged until the contest ends.
      {% endif %}
    </li>
    <li class="item">
      {% if contest.allow_code_share == 0 %}
      Codes are not shared under any circumstances.
      {% elif contest.allow_code_share == 1 %}
      Certain codes are available <b>after</b> the contest, if you have solved the problem.
      {% elif contest.allow_code_share == 2 %}
      All codes go public after the contest.
      {% else %}
      Certain codes are available <b>during</b> the contest, if you have solved the problem.
      {% endif %}
    </li>
    <li class="item">
      {% if contest.last_counts %}
        Your <b>latest</b> submission will be scored.
      {% else %}
        Your <b>best-scored</b> submission will be scored.
      {% endif %}
    </li>
    <li class="item">
      {% if contest.penalty_counts %}
        Penalty will determine the rank among participants with the same score. The total penalty is the sum of the time consumed for each problem solved. The time consumed for a solved problem is the time elapsed from the beginning of the contest to the submittal of the accepted run plus 20 penalty minutes for every rejected run for that problem regardless of submittal time. There is no time consumed for a problem that is not solved.
      {% else %}
        Penalty will not be calculated.
      {% endif %}
    </li>
    {% if contest.standings_disabled %}
      <li class="item">Standings are closed now.</li>
    {% endif %}
  </ul>
  {{ separator() }}

  {% if contest.rated %}
  {% endif %}

  {# annoucement #}


{% endblock %}